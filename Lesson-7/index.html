<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Snake Game</title>
  <style>
    body {
      text-align: center;
    }

    #gameZone {
      margin: 30px auto;
      border: 5px solid #DAE2E9;
      line-height: 0;
    }

    #gameZone div {
      width: 15px;
      height: 15px;
      display: inline-block;
      border-left: 1px solid #f7fbfd;
      border-bottom: 1px solid #f7fbfd;
    }

    .active_body {
      background: #00C790;
    }

    .active_head {
      background: #008080;
    }

    .food {
      background: #8A9DE1;
    }
  </style>
</head>

<body>

  <h1>Python</h1>
  <p id="info">:</p>
  <div id="gameZone"></div>
  <p> [ENTER] = New game, [SPACE] = Pause</p>

  <script>

    "use strict"

    var cols = 20
      , rows = 15
      , countSectors = cols * rows
      , widthFildPx = cols * 15 + cols
      , cells = null
      , cellDivElement
      , direction = { x: +1, y: 0 }
      , python = setStartPositionPartsPython()
      , positionFoodNum = null
      , isPauesed = false
      , timeIntervalMove = 500;

    function setStartPositionPartsPython() {
      var position = cols * rows / 2;
      return [position, position - 1];
    };

    var gameBlockId = document.getElementById('gameZone');
    var statsBlockId = document.getElementById('info');
    document.addEventListener('keydown', dispatcherEventKey);

    function generationMap(cols, rows) {

      for (var i = 0; i < countSectors; i++) {
        cellDivElement = document.createElement("div");
        gameBlockId.appendChild(cellDivElement);
      }

      gameBlockId.style.width = widthFildPx + "px";
      cells = gameBlockId.querySelectorAll("div");
    };

    function converterPositionToAxes(_positionNum) {
      var x = _positionNum % cols;
      var y = Math.floor(_positionNum / cols);
      return { x: x, y: y };
    };

    function convertAxesToPosition(direction) {
      var position = direction.y * cols + direction.x;
      return position;
    };

    function movementPython() {

      var firstPart = python[0];

      var _positionAddNewStepNum = convertAxesToPosition(direction);
      // python[0] = moveThroughWall(python[0], _positionAddNewStepNum);
        // cells[python[i]].className = '';
        // cells[python[i]].className = 'active_body';
      // python.unshift(python.pop());
      python[0] += _positionAddNewStepNum;

      // console.log(python);

      if (python[0] == positionFoodNum) {
        // console.log(positionFoodNum)
        python.push(0);
        // console.log(firstPart);
        positionFoodNum = null;
      }
        
      // cells[python[0]].className = 'active_head';

      
      for (var i = 0; i < python.length; i++) {
        cells[python[i]].className = '';
        cells[python[i]].className = 'active_body';
        // python[i] = python[i];
        // console.log(python);
      }
    }

    function moveThroughWall(_positionHeadNum, _positionAddStepNum) {
      var axesHead = converterPositionToAxes(_positionHeadNum);

      if (direction.x == -1 && axesHead.x <= 0)
        return _positionHeadNum + cols - 1;

      if (direction.y == -1 && axesHead.y <= 0)
        return cols * (rows - 1) + _positionHeadNum;

      if (direction.x == +1 && axesHead.x + 1 >= cols)
        return _positionHeadNum - cols + 1;

      if (direction.y == +1 && axesHead.y + 1 >= rows)
        return _positionHeadNum % cols;

      return _positionHeadNum += _positionAddStepNum;
    }

    function dispatcherEventKey(e) {

      if (e.keyCode == 38 && direction.y != +1)
        return direction = { x: 0, y: -1 };

      if (e.keyCode == 40 && direction.y != -1)
        return direction = { x: 0, y: +1 };

      if (e.keyCode == 37 && direction.x != +1)
        return direction = { x: -1, y: 0 };

      if (e.keyCode == 39 && direction.x != -1)
        return direction = { x: +1, y: 0 };

      if (e.keyCode == 32)
        isPauesed = (!isPauesed) ? true : false;
    };

    var timerIteration = setInterval(function () {
      if (!isPauesed) {
        movementPython();
        createPositionFood();
      }
    }, timeIntervalMove)

    function createPositionFood() {
      if (!positionFoodNum) {
        positionFoodNum = Math.floor(Math.random() * (countSectors - 0));
        if (python.includes(positionFoodNum)) {
          positionFoodNum = null;
          console.log("Еда попала сразу в желудок змейки")
          createPositionFood();
          return;
        }
        cells[positionFoodNum].className = 'food';
      }
    }

    // Python.prototype.throughWallsOn = function (head) {
    //   if (head.x < 0) head.x = field.cols - 1;
    //   if (head.y < 0) head.y = field.rows - 1;
    //   if (head.x >= field.cols) head.x = 0;
    //   if (head.y >= field.rows) head.y = 0;
    // };

    // Python.prototype.deadLoop = function (positionHead) {
    //   this.body.forEach(function (posPart, i) {
    //     if (positionHead === posPart && i !== 0) {
    //       game.gameover = 1;
    //       field.cells[posPart].style.background = 'red';
    //     }
    //   });
    // };

    // Python.prototype.eatsMeat = function (positionHead) {
    //   if (positionHead === field.positionMeat) {
    //     this.body.push(0);
    //     field.hunger = true;
    //   }
    // };

    function Game() {
      this.speed = 200;
      this.active = 0;
      this.gameover = 0;
      //this.level = 1;
      this.life = 5;
    }

    Game.prototype.run = function (field, python) {

      var self = this;

      python.render();
      statsBlockId.innerHTML = 'Speed: ' + this.speed + 'ms';
      BUFFER_KEY = undefined;

      (function setTime() {
        field.generationMeat(python.body);
        var timerIteration = setInterval(function () {
          if (field.hunger) {
            self.speed -= 5;
            statsBlockId.innerHTML = 'Speed: ' + self.speed + 'ms';
            clearInterval(timerIteration);
            setTime();
          }
          if (self.active && !self.gameover) {
            python.render();
          }
        }, self.speed);
      })()
    };

    Game.prototype.start = function () {
      this.active = 1;
    }

    Game.prototype.pause = function () {
      this.active = (this.active === 0) ? 1 : 0;
    }
    // var game = new Game();
    // var field = new Field(28, 20);
    // var python = new Python(game, field);
    // game.run(field, python);

    generationMap();

  </script>

</body>

</html>