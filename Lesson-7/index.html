<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Snake Game</title>
  <style>
    div,
    p,
    span {
      margin: 0;
      padding: 0;
      border: 0;
    }

    .wrap {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      overflow: auto;
      white-space: nowrap;
      text-align: center;
      font-size: 0;

      &:before {
        height: 100%;
        display: inline-block;
        vertical-align: middle;
        content: '';
      }
    }

    .content {
      display: inline-block;
      white-space: normal;
      vertical-align: middle;
      text-align: center;
      font-size: 10pt;
    }

    #gameZone {
      margin-top: 30px;
      border: 4px solid #DAE2E9;
      line-height: 0;
    }

    #gameZone div {
      width: 15px;
      height: 15px;
      display: inline-block;
      border-left: 1px solid #f7fbfd;
      border-bottom: 1px solid #f7fbfd;
    }

    .active_body {
      background: #00C790;
    }

    .active_head {
      background: #008080;
    }

    .meat {
      background: #8A9DE1;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="content">
      <div>
        <h1>Python</h1>
        <p id="stats"></p>
      </div>
      <div id="gameZone"></div>
      <div id="stats">arcvs@2019</div>
    </div>
  </div>

  <script>
    "use strict"

    var cols = 20
      , rows = 20
      , countSectors = cols * rows
      , widthFildPx = cols * 15 + cols
      , cells = null
      , cellDivElement
      , direction = { x: 1, y: 0 }
      , python = setStartPositionPartPython();

    function setStartPositionPartPython() {
      var position = cols * rows / 2 - cols / 2;
      return [position, position - 1];
    };

    var gameBlockId = document.getElementById('gameZone');
    var statsBlockId = document.getElementById('stats');
    document.addEventListener('keydown', dispatcherEventKey);

    function generationMap(cols, rows) {

      for (var i = 0; i < countSectors; i++) {
        cellDivElement = document.createElement("div");
        gameBlockId.appendChild(cellDivElement);
      }

      gameBlockId.style.width = widthFildPx + "px";
      cells = gameBlockId.querySelectorAll("div");
    };


    function converterPositionToAxes(field, a) {
      var x = a % field.cols;
      var y = Math.floor(a / field.cols);
      return { x: x, y: y };
    };

    function convertAxesToPosition(direction) {
      var position = direction.y * cols + direction.x;
      return position;
    };

    function movementPython(_position) {

      var firstPart = python[0];

      python[0] += _position;
      cells[python[0]].className = 'active_head';
      cells[python[python.length - 1]].className = '';

      for (var i = 1; i < python.length; i++) {
        python[i] = firstPart;
        cells[python[i]].className = 'active_body';
      }
      // console.log(python)
    }

    function definitionTransparentWalls() {
      
    }

    function dispatcherEventKey(e) {

      switch (e.keyCode) {
        case 38:
          if (direction.y != +1) {
            direction = { x: 0, y: -1 };
          }
          break;

        case 40:
          if (direction.y != -1) {
            direction = { x: 0, y: +1 };
          }
          break;

        case 37:
          if (direction.x != +1) {
            direction = { x: -1, y: 0 };
          }
          break;

        case 39:
          if (direction.x != -1) {
            direction = { x: +1, y: 0 };
          }
          break;

        case 32: game.pause(); break;
      };
      console.log(direction)
    };

    // document.onkeydown = function (event) {
    //   if ((event.keyCode >= 32) && (event.keyCode <= 40)) {
    //     dispatcherEventKey(event.keyCode);
    //   };
    // };

    // displayPython()
    // console.dir(cells)

    var timerIteration = setInterval(function () {
      // if (1) {
      //   self.speed -= 5;
      //   statsBlockId.innerHTML = 'Speed: ' + self.speed + 'ms';
      //   clearInterval(timerIteration);
      //   setTime();
      // }
      movementPython(convertAxesToPosition(direction));
      //       if (self.active && !self.gameover) {
      //         python.render();
      //       }
    }, 500)



    function generationMeat(python) {


      function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      (function checkPositionPythonAndMeat() {
        var positionMeat = getRandomInt(0, countSectors - 1);
        //  python.forEach(function (item, i) {
        //    if (item === positionMeat) {
        //      return checkPositionPythonAndMeat();
        //    }
        //  })
      })()

      //  this.hunger = false;
      //  this.cells[this.positionMeat].className = 'meat';
    };



    function Python(game, field) {
      var direction = { x: 0, y: 0 };
      var body = setStartPositionPython();
      var nextPositionStep = NaN;

      this._step = function (i) {

        var backStep = this.body[i];

        if (i === 0) {
          var head = converterPositionToAxes(field, this.body[i]);
          head.x += this.direction.x;
          head.y += this.direction.y;
          this.throughWallsOn(head);
          this.body[i] = converterAxesToPosition(field, head.x, head.y);

          this.deadLoop(this.body[i]);
          this.eatsMeat(this.body[i]);
        } else {
          // NaN - обеспечивает правильную работу части тела в нулевой позиции 
          this.body[i] = isNaN(this.nextPositionStep) ? backStep : this.nextPositionStep;
        }

        //  if (game.gameover) {
        //    return 0;
        //  }

        field.cells[this.body[i]].className = 'active' + (!i ? 0 : '');

        if (this.direction.x || this.direction.y) {
          field.cells[backStep].className = '';
          return backStep;
        }
      }
    };


    Python.prototype.render = function () {
      var self = this;
      this.body.forEach(function (iteam, i) {
        self.nextPositionStep = self._step(i);
      });
    }

    Python.prototype.throughWallsOn = function (head) {
      if (head.x < 0) head.x = field.cols - 1;
      if (head.y < 0) head.y = field.rows - 1;
      if (head.x >= field.cols) head.x = 0;
      if (head.y >= field.rows) head.y = 0;
    };


    Python.prototype.deadLoop = function (positionHead) {
      this.body.forEach(function (posPart, i) {
        if (positionHead === posPart && i !== 0) {
          game.gameover = 1;
          field.cells[posPart].style.background = 'red';
        }
      });
    };

    Python.prototype.eatsMeat = function (positionHead) {
      if (positionHead === field.positionMeat) {
        this.body.push(0);
        field.hunger = true;
      }
    };

    function Game() {
      this.speed = 200;
      this.active = 0;
      this.gameover = 0;
      //this.level = 1;
      this.life = 5;
    }

    Game.prototype.run = function (field, python) {

      var self = this;

      python.render();
      statsBlockId.innerHTML = 'Speed: ' + this.speed + 'ms';
      BUFFER_KEY = undefined;

      (function setTime() {
        field.generationMeat(python.body);
        var timerIteration = setInterval(function () {
          if (field.hunger) {
            self.speed -= 5;
            statsBlockId.innerHTML = 'Speed: ' + self.speed + 'ms';
            clearInterval(timerIteration);
            setTime();
          }
          if (self.active && !self.gameover) {
            python.render();
          }
        }, self.speed);
      })()
    };

    Game.prototype.start = function () {
      this.active = 1;
    }

    Game.prototype.pause = function () {
      this.active = (this.active === 0) ? 1 : 0;
    }
    // var game = new Game();
    // var field = new Field(28, 20);
    // var python = new Python(game, field);
    // game.run(field, python);



    generationMap();
    generationMeat();

  </script>

</body>

</html>